name: Build & Push Jupyter Image

on:
    push:
        branches:
            - main
        paths:
            - "Dockerfile.jupyter"
            - "config/jupyter/jupyterhub_config.py"
            - "packages/jupyter_jwt_auth/**"
            - "version.jupyter.txt"

    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: celine-eu/jupyter

permissions:
    contents: read
    packages: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Read Jupyter version
              id: version
              run: |
                  VERSION=$(cat version.jupyter.txt | tr -d ' \n')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Jupyter image
              run: |
                  IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  VERSION=${{ steps.version.outputs.version }}

                  echo "Building $IMAGE:$VERSION and $IMAGE:latest"

                  docker build \
                    -f Dockerfile.jupyter \
                    -t $IMAGE:$VERSION \
                    -t $IMAGE:latest \
                    .

                  docker push $IMAGE:$VERSION
                  docker push $IMAGE:latest
